function handleFileSelect(e) { for (var a = e.target.files, t = document.getElementById("list") ; t.firstChild;) t.removeChild(t.firstChild); imgNumArray = []; for (var i, l = 0; i = a[l]; l++) if (i.num = l, i.type.match("image.*")) { var n = new FileReader; n.onload = function (e) { return function (a) { var t = document.createElement("span"); imgNum = e.num, t.addClass = "imageDiv", t.innerHTML = ['<div class="row"><div class="col-md-8"><div tags="0" class="imgSpan" id="', imgNum + "s", '"><img class="imageShow" id="', imgNum, '" src="', a.target.result, '" title="', escape(e.name), '"/></div><textarea class="form-control" id="', imgNum + "ta", '" placeholder="Skriv litt om bildet..."></textarea></div><div class="col-md-4 rightImageDiv"><btn id="', imgNum + "b", '" class="btn btn-primary"><span class="glyphicon glyphicon-open"></span> Last opp</btn><br/><br/><div class="statustxt" id="', imgNum + "t", '">0%</div><div class="progress"><div id="', imgNum + "p", '" class="progress-bar progress-bar-striped active" role="progressbar" aria-valuenow="40" aria-valuemin="0" aria-valuemax="100" style="width:0%"></div></div><span id="', imgNum + "st", '"></span><br/><btn id="', imgNum + "bf", '" class="btn btn-primary">Detekt ansikter</btn><btn id="', imgNum + "bd", '" class="btn btn-primary" style="margin-left:30px;">Fjern alle tags</btn></div></div><hr>'].join(""), document.getElementById("list").insertBefore(t, null), addHandeler(imgNum) } }(i), n.readAsDataURL(i) } $("#buttonAll").attr("disabled", !1), $("#buttonAll").css({ display: "" }) } function addHandeler(e) { $("#" + e + "s").dblclick(function (a) { n += 1; var t = $(this).parent().offset(), i = a.pageX - t.left - 15 - 75, l = a.pageY - t.top - 75; i + 150 > $("#" + e).width() && (i -= i + 150 - $("#" + e).width()), l + 150 > $("#" + e).height() && (l -= l + 150 - $("#" + e).height()), i < 0 && (i = 0), l < 0 && (l = 0), createTag(e, n, i, l, 150, 150) }), $("#" + e + "b").on("click", function () { $("#files").get(0).files[e].type.match("image.*") ? sendFile(e) : alert("You can only upload images") }), $("#" + e + "bf").on("click", function () { $("#" + e).faceDetection({ complete: function (a) { 0 === a.length && $("#" + e + "st").text("Fant ingen ansikter"); for (var t = 0; t < a.length; t++) { var i = a[t].x * a[t].scaleX, l = a[t].y * a[t].scaleY + 5, s = a[t].height * a[t].scaleY + 50, r = a[t].width * a[t].scaleX + 10; createTag(e, n, i, l, r, s), n += 1 } } }) }), $("#" + e + "bd").on("click", function () { $("#" + e + "s").children("div").each(function () { document.getElementById(e + "s").removeChild(this) }) }) } function createTag(e, a, t, i, l, n) { var s = $('<div class="box" id="' + e + a + '"><span onclick="func(this)" class="glyphicon glyphicon-remove-circle"></span></div>').css({ left: t + "px", top: i + "px", width: l, height: n }), r = $('<input id="' + e + a + 'p" class="inp tagInput">'); $("#" + e + "s").append(s), s.append(r), $("#" + e + a).draggable({ cursor: "crosshair", containment: "#" + e }), $("#" + e + a).resizable({ containment: "#" + e }), $("#" + e + a).on("click", function (e) { e.stopPropagation(), e.preventDefault() }), $("#" + e + a + "p").on("input", function () { if ($(this).val()) { var t = $("#" + e + a + "p").val(); $.ajax({ url: "/Admin/Home/GetUsers", async: !0, contentType: !1, processData: !1, type: "POST", dataType: "json", data: t, xhr: function () { var e = $.ajaxSettings.xhr(); return e.upload, e }, success: function (i) { for (var l = [], n = 0; n < i.length; n++) { var s = { label: i[n].Name, id: i[n].Id, imgid: i[n].imgId, type: i[n].type, email: i[n].email }; l.push(s) } $("#" + e + a + "p").autocomplete({ source: l, select: function (t, i) { $("#" + e + a).attr("name", i.item.label), $("#" + e + a).attr("nameid", i.item.id), $("#" + e + a).attr("type", i.item.type), $("#" + e + a).attr("title", i.item.label), t.preventDefault() }, focus: function (t, i) { return $("#" + e + a + "p").val(i.item.label), $("#" + e + a).attr("name", i.item.label), $("#" + e + a).attr("nameid", i.item.id), $("#" + e + a).attr("type", i.item.type), !1 } }), $("#" + e + a + "p").data("ui-autocomplete")._renderItem = function (e, a) { if (0 === a.imgid) { i = $("<li>"); return t = "" == a.email ? $('<label class="autoLabel"><div class="row"><div class="col-md-3"><i class="fa fa-question-circle autoQuestionChild" aria-hidden="true"></i></div><div class="col-md-9">' + a.label + "</div></div></label>") : $('<label class="autoLabel"><div class="row"><div class="col-md-3"><i class="fa fa-question-circle autoQuestion" aria-hidden="true"></i></div><div class="col-md-9">' + a.label + '<br><span class="autoEmailStyle">' + a.email + "</span></div></div></label>"), i.attr("data-value", a.label), i.append("<a>"), i.find("a").append(t), i.appendTo(e) } var t, i = $("<li>"); return t = "" == a.email ? $('<label class="autoLabel"><div class="row"><div class="col-md-3"><img src="../FileAdmin?id=' + a.imgid + '" class="thumbnailShow"></div><div class="col-md-9">' + a.label + "</div></div></label>") : $('<label class="autoLabel"><div class="row"><div class="col-md-3"><img src="../FileAdmin?id=' + a.imgid + '" class="thumbnailShow"></div><div class="col-md-9">' + a.label + '<br><span class="autoEmailStyle">' + a.email + "</span></div></div></label>"), i.attr("data-value", a.label), i.append("<a>"), i.find("a").append(t), i.appendTo(e) }, $("#" + e + a + "p").autocomplete("search", t) }, error: function (e) { alert(e.statusText), console.log(e) } }) } }) } function sendFile(e) { if (void 0 !== window.FormData) { var a = $("#files").get(0).files; if (-1 === imgNumArray.indexOf(e)) { var t = new FormData; t.append(a[e].name, a[e]); var i = $("#" + e).get(0).naturalHeight, l = $("#" + e).get(0).naturalWidth, n = parseInt($("#" + e).css("width"), 10), s = parseInt($("#" + e).css("height"), 10) / i, r = n / l, d = []; $("#" + e + "s").children("div").each(function () { var e = this.getAttribute("id"); if ("" !== $("#" + e + "p").val()) { var a = $("#" + e), t = { id: this.getAttribute("nameid"), name: this.getAttribute("name"), type: this.getAttribute("type"), x: parseInt(parseFloat(a.css("left")) / r), y: parseInt(parseFloat(a.css("top")) / s), height: parseInt(parseFloat(a.css("height")) / s), width: parseInt(parseFloat(a.css("width")) / r) }; i < 500 && (t.height += 30), t.name !== $("#" + e + "p").val() && (t.name = $("#" + e + "p").val(), t.id = void 0), d.push(t) } }), d = JSON.stringify(d), t.append("tags", d), t.append("caption", $("#" + e + "ta").val()), $.ajax({ url: "/Admin/Home/UploadFiles", type: "POST", contentType: !1, processData: !1, data: t, xhr: function () { var a = $.ajaxSettings.xhr(); return a.upload && (a.upload.id = e, a.upload.addEventListener("progress", progressHandlingFunction, !1)), a }, success: function (a) { imgNumArray.push(e), $("#" + e + "t").text(a) }, error: function (a) { $("#" + e + "t").text(a.statusText) } }) } else $("#" + e + "t").text("Filen er allerede opplastet") } else alert("FormData er ikke støttet.") } function progressHandlingFunction(e) { var a = e.target.id; if (e.lengthComputable) { var t = Math.floor(e.loaded / e.total * 100); $("#" + a + "t").text(t + "%"), $("#" + a + "p").css("width", t + "%") } } function func(e) { e.parentNode.parentNode.removeChild(e.parentNode) } var imgNum = 0, imgNumArray = [], inside = !1, n = 0, tagObj = {}; document.getElementById("files").addEventListener("change", handleFileSelect, !1), $("#buttonAll").on("click", function () { for (var e = $("#files").get(0).files, a = 0; a < e.length; a++) e[a].type.match("image.*") ? sendFile(a) : alert("Du kan kun laste opp bilder") });